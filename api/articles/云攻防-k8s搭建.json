{"title":"云攻防-K8S安全","uid":"aa2cc9f18c0295fd4c228dc62555a6a1","slug":"云攻防-k8s搭建","date":"2025-05-17T09:03:45.056Z","updated":"2025-05-17T09:15:13.087Z","comments":true,"path":"api/articles/云攻防-k8s搭建.json","keywords":null,"cover":"https://myhaoblog.oss-cn-beijing.aliyuncs.com/blog%20%E5%9B%BE%E7%89%87/07d4681d-b7f1-4d6f-b718-c01399944150.jpg","content":"<h1 id=\"云攻防-k8s手动搭建\"><a href=\"#云攻防-k8s手动搭建\" class=\"headerlink\" title=\"云攻防-k8s手动搭建\"></a>云攻防-k8s手动搭建</h1><p>国内网络环境 优化的 CentOS 7 部署 Kubernetes 集群详细步骤,及常见问题</p>\n<h2 id=\"一、环境准备（所有节点执行）\"><a href=\"#一、环境准备（所有节点执行）\" class=\"headerlink\" title=\"一、环境准备（所有节点执行）\"></a>一、环境准备（所有节点执行）</h2><h3 id=\"1-配置主机名与-hosts-解析\"><a href=\"#1-配置主机名与-hosts-解析\" class=\"headerlink\" title=\"1. 配置主机名与 hosts 解析\"></a>1. 配置主机名与 hosts 解析</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Master 节点</span></span><br><span class=\"line\">hostnamectl set-hostname k8s-master</span><br><span class=\"line\"><span class=\"meta prompt_\"> </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Worker 节点（如 node1）</span></span><br><span class=\"line\">hostnamectl set-hostname k8s-node1</span><br><span class=\"line\"><span class=\"meta prompt_\"> </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">所有节点编辑 /etc/hosts</span></span><br><span class=\"line\">cat &lt;&lt;EOF &gt;&gt; /etc/hosts</span><br><span class=\"line\">&lt;Master节点内网IP&gt; k8s-master</span><br><span class=\"line\">&lt;Worker节点内网IP&gt; k8s-node1</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<h3 id=\"2-关闭防火墙、SELinux-和-Swap\"><a href=\"#2-关闭防火墙、SELinux-和-Swap\" class=\"headerlink\" title=\"2. 关闭防火墙、SELinux 和 Swap\"></a>2. 关闭防火墙、SELinux 和 Swap</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl stop firewalld &amp;&amp; systemctl disable firewalld</span><br><span class=\"line\">setenforce 0</span><br><span class=\"line\">sed -i &#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27; /etc/selinux/config</span><br><span class=\"line\">swapoff -a</span><br><span class=\"line\">sed -i &#x27;/ swap / s/^\\(.*\\)$/#\\1/g&#x27; /etc/fstab  # 永久关闭 Swap</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-配置内核参数\"><a href=\"#3-配置内核参数\" class=\"headerlink\" title=\"3. 配置内核参数\"></a>3. 配置内核参数</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf</span><br><span class=\"line\">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class=\"line\">net.bridge.bridge-nf-call-iptables = 1</span><br><span class=\"line\">net.ipv4.ip_forward = 1</span><br><span class=\"line\">EOF</span><br><span class=\"line\">sysctl --system</span><br></pre></td></tr></table></figure>\n<h3 id=\"4-加载内核模块\"><a href=\"#4-加载内核模块\" class=\"headerlink\" title=\"4. 加载内核模块\"></a>4. 加载内核模块</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">modprobe br_netfilter</span><br><span class=\"line\">modprobe overlay</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"二、安装容器运行时（所有节点执行）\"><a href=\"#二、安装容器运行时（所有节点执行）\" class=\"headerlink\" title=\"二、安装容器运行时（所有节点执行）\"></a>二、安装容器运行时（所有节点执行）</h2><p>CentOS 7 yum 无法使用</p>\n<p>CentOS 7 仓库已经被归档，当前的镜像地址无法找到所需的文件。CentOS 7 的官方支持已经结束，部分仓库已被移至归档库。这导致了 yum 命令无法找到所需的元数据文件。CentOS 7 的官方仓库在 2024 年 6 月 30 日之后已经停止维护。因此，使用最新的 CentOS 7 官方仓库可能会遇到问题。</p>\n<p>参考文章：</p>\n<p><a href=\"https://blog.csdn.net/weixin_68792404/article/details/147272888\">https://blog.csdn.net/weixin_68792404/article/details/147272888</a></p>\n<p>解决方法:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /etc/yum.repos.d</span><br><span class=\"line\">cp  CentOS-Base.repo   CentOS-Base.repo.backup</span><br><span class=\"line\">vi CentOS-Base.repo</span><br><span class=\"line\">修改内容</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">CentOS-Base.repo</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"language-bash\"><span class=\"comment\"># The mirror system uses the connecting IP address of the client and the</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">update status of each mirror to pick mirrors that are updated to and</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">geographically close to the client.  You should use this <span class=\"keyword\">for</span> CentOS updates</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">unless you are manually picking other mirrors.</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"language-bash\"><span class=\"comment\"># If the mirrorlist= does not work for you, as a fall back you can try the</span></span> </span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">remarked out baseurl= line instead.</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"></span></span><br><span class=\"line\"><span class=\"language-bash\"><span class=\"comment\">#</span></span></span><br><span class=\"line\"> </span><br><span class=\"line\">[base]</span><br><span class=\"line\">name=CentOS-$releasever - Base</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">mirrorlist=http://mirrorlist.centos.org/?release=<span class=\"variable\">$releasever</span>&amp;<span class=\"built_in\">arch</span>=<span class=\"variable\">$basearch</span>&amp;repo=os&amp;infra=<span class=\"variable\">$infra</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">baseurl=http://mirror.centos.org/centos/<span class=\"variable\">$releasever</span>/os/<span class=\"variable\">$basearch</span>/</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">baseurl=http://vault.centos.org/7.9.2009/x86_64/os/</span></span><br><span class=\"line\">baseurl=http://vault.centos.org/7.9.2009/os/$basearch/</span><br><span class=\"line\">gpgcheck=1</span><br><span class=\"line\">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7</span><br><span class=\"line\"><span class=\"meta prompt_\"> </span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">released updates</span> </span><br><span class=\"line\">[updates]</span><br><span class=\"line\">name=CentOS-$releasever - Updates</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">mirrorlist=http://mirrorlist.centos.org/?release=<span class=\"variable\">$releasever</span>&amp;<span class=\"built_in\">arch</span>=<span class=\"variable\">$basearch</span>&amp;repo=updates&amp;infra=<span class=\"variable\">$infra</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">baseurl=http://mirror.centos.org/centos/<span class=\"variable\">$releasever</span>/updates/<span class=\"variable\">$basearch</span>/</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">baseurl=http://vault.centos.org/7.9.2009/x86_64/os/</span></span><br><span class=\"line\">baseurl=http://vault.centos.org/7.9.2009/updates/$basearch/</span><br><span class=\"line\">gpgcheck=1</span><br><span class=\"line\">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7</span><br><span class=\"line\"><span class=\"meta prompt_\"> </span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">additional packages that may be useful</span></span><br><span class=\"line\">[extras]</span><br><span class=\"line\">name=CentOS-$releasever - Extras</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">mirrorlist=http://mirrorlist.centos.org/?release=<span class=\"variable\">$releasever</span>&amp;<span class=\"built_in\">arch</span>=<span class=\"variable\">$basearch</span>&amp;repo=extras&amp;infra=<span class=\"variable\">$infra</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"variable\">$baseurl</span>=http://mirror.centos.org/centos/<span class=\"variable\">$releasever</span>/extras/<span class=\"variable\">$basearch</span>/</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">baseurl=http://vault.centos.org/7.9.2009/x86_64/os/</span></span><br><span class=\"line\">baseurl=http://vault.centos.org/7.9.2009/extras/$basearch/</span><br><span class=\"line\">gpgcheck=1</span><br><span class=\"line\">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7</span><br><span class=\"line\"><span class=\"meta prompt_\"> </span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">additional packages that extend functionality of existing packages</span></span><br><span class=\"line\">[centosplus]</span><br><span class=\"line\">name=CentOS-$releasever - Plus</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">mirrorlist=http://mirrorlist.centos.org/?release=<span class=\"variable\">$releasever</span>&amp;<span class=\"built_in\">arch</span>=<span class=\"variable\">$basearch</span>&amp;repo=centosplus&amp;infra=<span class=\"variable\">$infra</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">baseurl=http://mirror.centos.org/centos/<span class=\"variable\">$releasever</span>/centosplus/<span class=\"variable\">$basearch</span>/</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">baseurl=http://vault.centos.org/7.9.2009/x86_64/os/</span></span><br><span class=\"line\">baseurl=http://vault.centos.org/7.9.2009/centosplus/$basearch/</span><br><span class=\"line\">gpgcheck=1</span><br><span class=\"line\">enabled=0</span><br><span class=\"line\">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7</span><br></pre></td></tr></table></figure>\n<p>保存后执行</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo yum clean all</span><br><span class=\"line\">sudo yum makecache</span><br></pre></td></tr></table></figure>\n<p>然后执行以下命令</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class=\"line\"> </span><br><span class=\"line\">sudo yum clean all</span><br><span class=\"line\">sudo yum makecache</span><br></pre></td></tr></table></figure>\n<h3 id=\"1-安装-Docker（国内镜像加速）\"><a href=\"#1-安装-Docker（国内镜像加速）\" class=\"headerlink\" title=\"1. 安装 Docker（国内镜像加速）\"></a>1. 安装 Docker（国内镜像加速）</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">使用阿里云 Docker 仓库</span></span><br><span class=\"line\">yum install -y yum-utils</span><br><span class=\"line\">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">安装指定版本 Docker</span></span><br><span class=\"line\">yum install -y docker-ce-20.10.23 docker-ce-cli-20.10.23 containerd.io</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">配置 Docker 镜像加速和 cgroup 驱动</span></span><br><span class=\"line\">mkdir -p /etc/docker</span><br><span class=\"line\">cat &lt;&lt;EOF &gt; /etc/docker/daemon.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;registry-mirrors&quot;: [&quot;https://&lt;你的阿里云镜像加速地址&gt;.mirror.aliyuncs.com&quot;],</span><br><span class=\"line\">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class=\"line\">  &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class=\"line\">  &quot;log-opts&quot;: &#123;&quot;max-size&quot;: &quot;100m&quot;&#125;,</span><br><span class=\"line\">  &quot;storage-driver&quot;: &quot;overlay2&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">启动 Docker</span></span><br><span class=\"line\">systemctl enable docker &amp;&amp; systemctl start docker</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"三、安装-Kubernetes-组件（所有节点执行）\"><a href=\"#三、安装-Kubernetes-组件（所有节点执行）\" class=\"headerlink\" title=\"三、安装 Kubernetes 组件（所有节点执行）\"></a>三、安装 Kubernetes 组件（所有节点执行）</h2><h3 id=\"1-配置阿里云-Kubernetes-仓库\"><a href=\"#1-配置阿里云-Kubernetes-仓库\" class=\"headerlink\" title=\"1. 配置阿里云 Kubernetes 仓库\"></a>1. 配置阿里云 Kubernetes 仓库</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class=\"line\">[kubernetes]</span><br><span class=\"line\">name=Kubernetes</span><br><span class=\"line\">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class=\"line\">enabled=1</span><br><span class=\"line\">gpgcheck=0</span><br><span class=\"line\">repo_gpgcheck=0</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<h3 id=\"2-安装-kubeadm、kubelet、kubectl\"><a href=\"#2-安装-kubeadm、kubelet、kubectl\" class=\"headerlink\" title=\"2. 安装 kubeadm、kubelet、kubectl\"></a>2. 安装 kubeadm、kubelet、kubectl</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">指定版本安装（示例版本 1.28.2）</span></span><br><span class=\"line\">yum install -y kubelet-1.28.2 kubeadm-1.28.2 kubectl-1.28.2 --disableexcludes=kubernetes</span><br><span class=\"line\"><span class=\"meta prompt_\"> </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">启动 kubelet</span></span><br><span class=\"line\">systemctl enable kubelet &amp;&amp; systemctl start kubelet</span><br></pre></td></tr></table></figure>\n<h2 id=\"四、初始化-Master-节点\"><a href=\"#四、初始化-Master-节点\" class=\"headerlink\" title=\"四、初始化 Master 节点\"></a>四、初始化 Master 节点</h2><p>安装网络插件:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">Flannel</span></span><br><span class=\"line\">kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml</span><br><span class=\"line\">kubectl get pods -n kube-system</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">Calico</span></span><br><span class=\"line\">curl -O https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/calico.yaml</span><br><span class=\"line\">sed -i &#x27;s#docker.io/calico/#registry.cn-hangzhou.aliyuncs.com/calico_community/#g&#x27; calico.yaml</span><br><span class=\"line\">kubectl apply -f calico.yaml</span><br></pre></td></tr></table></figure>\n<p>Kubernetes 从 1.24 版本开始已移除对 Docker 的直接支持，必须通过 cri-dockerd 适配器实现兼容。</p>\n<p>安装 cri-dockerd 适配器（所有节点安装）</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">下载最新版 cri-dockerd</span></span><br><span class=\"line\">wget https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.7/cri-dockerd-0.3.7.amd64.tgz</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">解压并安装</span></span><br><span class=\"line\">tar xvf cri-dockerd-0.3.7.amd64.tgz</span><br><span class=\"line\">sudo mv cri-dockerd/cri-dockerd /usr/local/bin/</span><br><span class=\"line\">sudo chmod +x /usr/local/bin/cri-dockerd</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"> </span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">创建 systemd 服务文件</span></span><br><span class=\"line\">cat &lt;&lt;EOF | sudo tee /usr/lib/systemd/system/cri-docker.service</span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=CRI Interface for Docker</span><br><span class=\"line\">After=network.target docker.service</span><br><span class=\"line\">Requires=docker.service</span><br><span class=\"line\"> </span><br><span class=\"line\">[Service]</span><br><span class=\"line\">ExecStart=/usr/local/bin/cri-dockerd --container-runtime-endpoint unix:///var/run/cri-dockerd.sock</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\"> </span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">启动服务</span></span><br><span class=\"line\">sudo systemctl daemon-reload</span><br><span class=\"line\">sudo systemctl enable cri-docker</span><br><span class=\"line\">sudo systemctl start cri-docker</span><br></pre></td></tr></table></figure>\n\n<p><strong>配置 kubelet 使用 Docker</strong></p>\n<p>创建 kubelet 配置文件</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo mkdir -p /etc/systemd/system/kubelet.service.d</span><br><span class=\"line\">cat &lt;&lt;EOF | sudo tee /etc/systemd/system/kubelet.service.d/0-cri-docker.conf</span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Environment=&quot;KUBELET_EXTRA_ARGS=--container-runtime=remote --container-runtime-endpoint=unix:///var/run/cri-dockerd.sock&quot;</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<p><strong>初始化 master 节点</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo kubeadm init \\</span><br><span class=\"line\">  --image-repository registry.aliyuncs.com/google_containers \\</span><br><span class=\"line\">  --apiserver-advertise-address 内网master的ip \\</span><br><span class=\"line\">  --pod-network-cidr=10.244.0.0/16 \\        </span><br><span class=\"line\">  --token-ttl 0 \\</span><br><span class=\"line\">  --cri-socket unix:///var/run/cri-dockerd.sock  # 关键参数！</span><br></pre></td></tr></table></figure>\n<p>成功后会输出以下命令，保存供 Worker 节点加入：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir -p $HOME/.kube</span><br><span class=\"line\">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class=\"line\">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>\n<p>node 加入集群 这里加入集群的命令每个人都不一样，可以登录 master 节点，使用 kubeadm token create –print-join-command 来获取。获取后在 node 主机下执行</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeadm join master节点ip:6443 --token s1dthx.saz58vfk2vjaxqcj \\</span><br><span class=\"line\">\t--discovery-token-ca-cert-hash sha256:6304e0c416ab6ab41f5de0aad71428c68099900063526f509c364237fe120051 </span><br></pre></td></tr></table></figure>\n<p>验证集群</p>\n<p>kubectl get nodes</p>\n<p>kubectl get pods -n kube-system</p>\n<p>如果存在master节点显示Ready了,但node节点是noready，说明了clicoa的网卡没有就绪，需要拉镜像</p>\n<p>实在没办法，咸鱼20块钱搞定</p>\n","text":"云攻防-k8s手动搭建国内网络环境 优化的 CentOS 7 部署 Kubernetes 集群详细步骤,及常见问题 一、环境准备（所有节点执行）1. 配置主机名...","permalink":"/post/云攻防-k8s搭建","photos":[],"count_time":{"symbolsCount":"7.2k","symbolsTime":"7 mins."},"categories":[{"name":"云安全","slug":"云安全","count":3,"path":"api/categories/云安全.json"}],"tags":[{"name":"云安全","slug":"云安全","count":3,"path":"api/tags/云安全.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E4%BA%91%E6%94%BB%E9%98%B2-k8s%E6%89%8B%E5%8A%A8%E6%90%AD%E5%BB%BA\"><span class=\"toc-text\">云攻防-k8s手动搭建</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%B8%80%E3%80%81%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87%EF%BC%88%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E6%89%A7%E8%A1%8C%EF%BC%89\"><span class=\"toc-text\">一、环境准备（所有节点执行）</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#1-%E9%85%8D%E7%BD%AE%E4%B8%BB%E6%9C%BA%E5%90%8D%E4%B8%8E-hosts-%E8%A7%A3%E6%9E%90\"><span class=\"toc-text\">1. 配置主机名与 hosts 解析</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99%E3%80%81SELinux-%E5%92%8C-Swap\"><span class=\"toc-text\">2. 关闭防火墙、SELinux 和 Swap</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#3-%E9%85%8D%E7%BD%AE%E5%86%85%E6%A0%B8%E5%8F%82%E6%95%B0\"><span class=\"toc-text\">3. 配置内核参数</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#4-%E5%8A%A0%E8%BD%BD%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97\"><span class=\"toc-text\">4. 加载内核模块</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BA%8C%E3%80%81%E5%AE%89%E8%A3%85%E5%AE%B9%E5%99%A8%E8%BF%90%E8%A1%8C%E6%97%B6%EF%BC%88%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E6%89%A7%E8%A1%8C%EF%BC%89\"><span class=\"toc-text\">二、安装容器运行时（所有节点执行）</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#1-%E5%AE%89%E8%A3%85-Docker%EF%BC%88%E5%9B%BD%E5%86%85%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F%EF%BC%89\"><span class=\"toc-text\">1. 安装 Docker（国内镜像加速）</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%B8%89%E3%80%81%E5%AE%89%E8%A3%85-Kubernetes-%E7%BB%84%E4%BB%B6%EF%BC%88%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%E6%89%A7%E8%A1%8C%EF%BC%89\"><span class=\"toc-text\">三、安装 Kubernetes 组件（所有节点执行）</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#1-%E9%85%8D%E7%BD%AE%E9%98%BF%E9%87%8C%E4%BA%91-Kubernetes-%E4%BB%93%E5%BA%93\"><span class=\"toc-text\">1. 配置阿里云 Kubernetes 仓库</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#2-%E5%AE%89%E8%A3%85-kubeadm%E3%80%81kubelet%E3%80%81kubectl\"><span class=\"toc-text\">2. 安装 kubeadm、kubelet、kubectl</span></a></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%9B%9B%E3%80%81%E5%88%9D%E5%A7%8B%E5%8C%96-Master-%E8%8A%82%E7%82%B9\"><span class=\"toc-text\">四、初始化 Master 节点</span></a></li></ol></li></ol>","author":{"name":"Hao","slug":"blog-author","avatar":"https://i.pinimg.com/736x/64/96/6b/64966b30e1c9375e8dbb11146ea9c12f.jpg","link":"/","description":"个人网络安全博客","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{"title":"Java安全学习路径","uid":"7c3e14f0681c54989a322aaf4933843e","slug":"Java安全学习路线","date":"2025-05-17T07:27:11.184Z","updated":"2025-05-17T09:15:50.655Z","comments":true,"path":"api/articles/Java安全学习路线.json","keywords":null,"cover":"https://myhaoblog.oss-cn-beijing.aliyuncs.com/blog%20%E5%9B%BE%E7%89%87/%23chudia%20%23anime%20%23wataa%20%23girl%20%23wlw.jpg","text":"参考文章： https://github.com/HackJava/HackJava ","permalink":"/post/Java安全学习路线","photos":[],"count_time":{"symbolsCount":43,"symbolsTime":"1 mins."},"categories":[{"name":"Java安全","slug":"Java安全","count":4,"path":"api/categories/Java安全.json"}],"tags":[{"name":"Java安全","slug":"Java安全","count":4,"path":"api/tags/Java安全.json"}],"author":{"name":"Hao","slug":"blog-author","avatar":"https://i.pinimg.com/736x/64/96/6b/64966b30e1c9375e8dbb11146ea9c12f.jpg","link":"/","description":"个人网络安全博客","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true},"next_post":{"title":"云攻防-自动化工具CDK","uid":"2d7ab8d810fa55a7f8f329a080d4b514","slug":"云攻防-自动化工具CDK","date":"2025-05-17T09:01:52.604Z","updated":"2025-05-17T09:03:14.960Z","comments":true,"path":"api/articles/云攻防-自动化工具CDK.json","keywords":null,"cover":"https://myhaoblog.oss-cn-beijing.aliyuncs.com/blog%20%E5%9B%BE%E7%89%87/03b0866b33895d638a5ad57f0285f8f7.jpg","text":"云攻防-自动化工具CDKhttps://github.com/cdk-team/CDK 概述 CDK 是一个开源的容器渗透工具包，旨在提供对各种精简容器的稳定利...","permalink":"/post/云攻防-自动化工具CDK","photos":[],"count_time":{"symbolsCount":147,"symbolsTime":"1 mins."},"categories":[{"name":"tools","slug":"tools","count":1,"path":"api/categories/tools.json"}],"tags":[{"name":"tools","slug":"tools","count":1,"path":"api/tags/tools.json"}],"author":{"name":"Hao","slug":"blog-author","avatar":"https://i.pinimg.com/736x/64/96/6b/64966b30e1c9375e8dbb11146ea9c12f.jpg","link":"/","description":"个人网络安全博客","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}